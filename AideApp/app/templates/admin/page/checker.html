{% extends 'admin/share/master.html' %}
{% block body %}
<!-- create task scan -->
    <!-- <div class="main-card mb-12 card">
        <div class="card-body">
            <h5 class="card-title">Check File With Aide GUI</h5>
            <form class="needs-validation" novalidate="" id="checkForm">
                <div class="form-row">
                    <div class="col-md-4 mb-3">
                        <label>Name of Scan</label>
                        <input type="text" class="form-control" id="inputTaskName" placeholder="Enter name of scan" required="">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="checkType">Check Type</label>
                        <select class="mb-2 form-control" id="checkType">
                            <option value="">Choose Check Type</option>
                            <option value="fullSystem">Full System Check</option>
                            <option value="specificFile">Check Specific File/Directory</option>
                            <option value="detailCheck">Detailed Check</option>
                            <option value="customConfig">Check with Custom Config</option>
                            <option value="customConfigAndFile">Check with Custom Config to Specific File</option>
                        </select>                       
                    </div>
                    <div class="col-md-4 mb-3" id="inputFileWrapper" style="display: none;">
                        <label for="inputSpecificFile">Input File</label>
                        <input type="text" class="form-control" id="inputSpecificFile" placeholder="Enter file name or directory to scan" required="">
                    </div>
                    <div class="col-md-4 mb-3" id="inputFileWrapper2" style="display: none;">
                        <label for="inputCustomConfig">Input Custom Config</label>
                        <input type="text" class="form-control" id="inputCustomConfig" placeholder="Enter custom config file" required="">
                    </div>
                </div>           
                <button class="btn btn-primary" type="submit">Run</button>
            </form>
            <br>        
        </div>
    </div>  -->

    <!-- //view task -->
    <div class="row">
        <div class="col-md-4" id="scanTask">        
            {% for task in tasks%}
            <div class="card mb-3 widget-content">
                <div class="widget-content-outer">
                    <div class="widget-content-wrapper">
                        <div class="widget-content-left">
                            <div class="widget-heading">{{ task.name }}</div>
                            <div class="widget-subheading">
                                {{ task.mapping_check_type }} 
                                {% if task.specific_file %}
                                - {{ task.specific_file }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="widget-content-right" style="display: flex">
                            {% if task.status != "SUCCESS" %}   
                                <button class="mb-2 mr-2 btn-transition btn btn-outline-warning task-action" data-task-id="{{ task.task_id }}" data-status="{{ task.status }}" style="display: block;">
                                    {% if task.status in ["RESUMED", "PENDING"] %}
                                        <i class="fa fa-fw" aria-hidden="true" title="Pause Task"></i>
                                    {% else %}
                                        <i class="fa fa-fw" aria-hidden="true" title="Resume Task"></i>
                                    {% endif %}
                                </button>
                            {% endif %}
                            <button class="mb-2 mr-2 btn-transition btn btn-outline-danger delete-task" type="button" data-toggle="modal" data-target="#deleteModal" data-task-id="{{task.task_id}}">
                                <i class="fa fa-fw" aria-hidden="true" title="Copy to use close"></i>
                            </button>                      
                        </div>
                    </div>
                    <div class="widget-progress-wrapper">
                        <div class="progress-bar-lg progress-bar-animated progress">
                            <div class="progress-bar bg-warning" role="progressbar" aria-valuenow="47" aria-valuemin="0" aria-valuemax="100" style="width: 30%;"></div>
                        </div>
                        <div class="progress-sub-label">
                            <div class="sub-label-left">{{ task.created_at }}</div> 
                            <div class="sub-label-right" data-toggle="modal" style="margin-top: 1%; display: block;">
                                {% if task.status in ["PENDING", "RESUMED"] %}
                                    <i class="fa fa-spinner fa-spin" id="spinner-icon" style="font-size: 21px;" style="display: block"></i>      
                                {% endif %}
                                {% if task.status == "SUCCESS" %}
                                    <button class="mb-2 mr-2 btn-transition btn btn-outline-info view-result" type="button" data-toggle="modal" data-target="#viewResult" data-task-id="{{task.task_id}}">View result scan</button>                            
                                {% endif %}
                            </div>
                        </div>   
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
   
    
{% endblock %}
{% block modal %}
 <!-- modal pop-up ensure confirm with their delete -->
<div class="modal fade show" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-modal="true" style="display: none; padding-left: 15px; margin-top: 8%;  margin-top: 9%;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Delete Scan Confirm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" >
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure to delete this scan permanently?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmDelete">yes</button>
            </div>
        </div>
    </div>
</div>  

<!-- modal view result -->
<div class="modal fade bd-example-modal-lg show" id="viewResult" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-modal="true" style="display: none; padding-left: 15px; margin-top: 3%;" >
<div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Scan Result</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"  >
                <span aria-hidden="true">×</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="scroll-area-lg">
                <ul class="list-group scrollbar-container ps--active-y ps">  
                    <div class="row">
                        <div class="col-md-6">
                            <div class="main-card mb-3 card">
                                <div class="card-body">
                                    <ul class="list-group">
                                        <li class="list-group-item">
                                            <div class="widget-content p-0">
                                                <div class="widget-content-outer">
                                                    <div class="widget-content-wrapper">
                                                        <div class="widget-content-left">
                                                            <div class="widget-heading">Total number of entries</div>
                                                            <div class="widget-subheading"></div>
                                                        </div>
                                                        <div class="widget-content-right" >
                                                            <div id="totalEntries" class="widget-numbers text-success"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="list-group-item">
                                            <div class="widget-content p-0">
                                                <div class="widget-content-outer">
                                                    <div class="widget-content-wrapper">
                                                        <div class="widget-content-left">
                                                            <div class="widget-heading">Added entries</div>
                                                            <div class="widget-subheading"></div>
                                                        </div>
                                                        <div class="widget-content-right">
                                                            <div id="addedEntries" class="widget-numbers text-primary"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="list-group-item">
                                            <div class="widget-content p-0">
                                                <div class="widget-content-outer">
                                                    <div class="widget-content-wrapper">
                                                        <div class="widget-content-left">
                                                            <div class="widget-heading">Removed entries</div>
                                                            <div class="widget-subheading"></div>
                                                        </div>
                                                        <div class="widget-content-right">
                                                            <div id="removedEntries" class="widget-numbers text-danger">1231</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="list-group-item">
                                            <div class="widget-content p-0">
                                                <div class="widget-content-outer">
                                                    <div class="widget-content-wrapper">
                                                        <div class="widget-content-left">
                                                            <div class="widget-heading">Changed entries</div>
                                                            <div class="widget-subheading"></div>
                                                        </div>
                                                        <div class="widget-content-right">
                                                            <div id="changedEntries" class="widget-numbers text-warning">123</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6" style="display: block">
                            <div class="main-card mb-3 card">
                                <div class="card-body" ><h5 class="card-title">The attributes of the (uncompressed) database(s)</h5>
                                    <div class="widget-subheading">/var/lib/aide/aide.db</div>
                                    <br>
                                    <div class="scroll-area-md">
                                        <ul class="list-group scrollbar-container ps--active-y ps" >                             
                                            <table class="mb-0 table table-striped">
                                                <thead>
                                                <tr>
                                                    <th>Algorithm</th>
                                                    <th>Value</th>
                                                </tr>
                                                </thead>
                                                <tbody id="AlgorithmHash">
                                                    <tr>
                                                        <td>MD5</td>
                                                        <td>0anQLiND+ROvDkli5JU4QA==</td>
                                                    </tr>
                                                    <tr>
                                                        <td>SHA1</td>
                                                        <td>fGy+oEhPYY8fy7XJbYWfTm5l9SM=</td>
                                                    </tr>
                                                    <tr>
                                                        <td>SHA256</td>
                                                        <td>LOFi51BQzIIpW9k4obMAdI2BXKJlA/dH5c4ccCk/YQQ=</td>
                                                    </tr>
                                                    <tr>
                                                        <td>MD5</td>
                                                        <td>0anQLiND+ROvDkli5JU4QA==</td>
                                                    </tr>
                                                    <tr>
                                                        <td>SHA1</td>
                                                        <td>fGy+oEhPYY8fy7XJbYWfTm5l9SM=</td>
                                                    </tr>
                                                    <tr>
                                                        <td>SHA256</td>
                                                        <td>LOFi51BQzIIpW9k4obMAdI2BXKJlA/dH5c4ccCk/YQQ=</td>
                                                    </tr>                           
                                                </tbody>
                                            </table>
                                        </ul>
                                        <div class="ps__rail-x" style="left: 0px; bottom: 0px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div>
                                        <div class="ps__rail-y" style="top: 0px; height: 200px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 45px;"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>   

                        <div class="col-md-4" style="display: block">
                            <div class="main-card mb-3 card">
                                <div class="card-body" ><h5 class="card-title">Added entries</h5>
                                    <div class="scroll-area-md">
                                        <ul class="list-group scrollbar-container ps--active-y ps" id="listAddedEntries">                             
                                            <li class="list-group-item">d+++++++++++++++++: /home/nguyen/test</li>
                                            <li class="list-group-item">f+++++++++++++++++: /home/nguyen/test/auditTest</li>                   
                                        </ul>
                                        <div class="ps__rail-x" style="left: 0px; bottom: 0px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div>
                                        <div class="ps__rail-y" style="top: 0px; height: 200px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 45px;"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>   
                        <div class="col-md-4" style="display: block">
                            <div class="main-card mb-3 card">
                                <div class="card-body" ><h5 class="card-title">Removed entries</h5>
                                    <div class="scroll-area-md">
                                        <ul class="list-group scrollbar-container ps--active-y ps" id="listRemovedEntries">                             
                                            <!-- <li class="list-group-item">d+++++++++++++++++: /home/nguyen/test</li>
                                            <li class="list-group-item">f+++++++++++++++++: /home/nguyen/test/auditTest</li>
                                        -->
                                        </ul>
                                        <div class="ps__rail-x" style="left: 0px; bottom: 0px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div>
                                        <div class="ps__rail-y" style="top: 0px; height: 200px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 45px;"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" style="display: block">
                            <div class="main-card mb-3 card">
                                <div class="card-body" ><h5 class="card-title">Changed entries</h5>
                                    <div class="scroll-area-md">
                                        <ul class="list-group scrollbar-container ps--active-y ps" id="listChangedEntries">                             
                                            <!-- <li class="list-group-item">d+++++++++++++++++: /home/nguyen/test</li>
                                            <li class="list-group-item">f+++++++++++++++++: /home/nguyen/test/auditTest</li>
                                        -->
                                        </ul>
                                        <div class="ps__rail-x" style="left: 0px; bottom: 0px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div>
                                        <div class="ps__rail-y" style="top: 0px; height: 200px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 45px;"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>      
                        <!-- <div class="col-md-6">
                            <div class="main-card mb-3 card">
                                <div class="card-body">
                                    <div class="chartjs-size-monitor" style="position: absolute; inset: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;">
                                        <div class="chartjs-size-monitor-expand" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                                            <div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0">
        
                                            </div>
                                        </div>
                                        <div class="chartjs-size-monitor-shrink" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                                            <div style="position:absolute;width:200%;height:200%;left:0; top:0">
        
                                        </div>
                                    </div>
                                </div>
                                    <h5 class="card-title">Pie Chart</h5>
                                    <canvas id="chart-area" width="604" height="301" style="display: block; height: 201px; width: 403px;" class="chartjs-render-monitor"></canvas>
                                </div>
                            </div>
                        </div>   -->
                        <div class="ps__rail-x" style="left: 0px; bottom: 0px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div>
                        <div class="ps__rail-y" style="top: 0px; height: 200px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 45px;"></div></div> 
                    </div>
                </ul> 
            </div>                
        </div>
        <div class="modal-footer d-flex justify-content-between">
            <div id="timestamp"></div> 
            <div>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
</div> 
<!-- modal create scan task -->
<div class="modal fade bd-example-modal-lg show" id="createScan" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-modal="true" style="display: none; padding-left: 15px; margin-top: 3%;" >
<div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Scan Result</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" >
                <span aria-hidden="true">×</span>
            </button>
        </div>
        <div clas="modal-body">
            <div class="main-card mb-12 card">
                <div class="card-body">
                    <h5 class="card-title">Check File With Aide GUI</h5>
                    <form class="needs-validation" novalidate="" id="checkForm">
                        <div class="form-row">
                            <div class="col-md-4 mb-3">
                                <label>Name of Scan</label>
                                <input type="text" class="form-control" id="inputTaskName" placeholder="Enter name of scan" required="">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="checkType">Check Type</label>
                                <select class="mb-2 form-control" id="checkType">
                                    <option value="">Choose Check Type</option>
                                    <option value="fullSystem">Full System Check</option>
                                    <option value="specificFile">Check Specific File/Directory</option>
                                    <option value="detailCheck">Detailed Check</option>
                                    <option value="customConfig">Check with Custom Config</option>
                                    <option value="customConfigAndFile">Check with Custom Config to Specific File</option>
                                </select>                       
                            </div>
                            <div class="col-md-4 mb-3" id="inputFileWrapper" style="display: none;">
                                <label for="inputSpecificFile">Input File</label>
                                <input type="text" class="form-control" id="inputSpecificFile" placeholder="Enter file name or directory to scan" required="">
                            </div>
                            <div class="col-md-4 mb-3" id="inputFileWrapper2" style="display: none;">
                                <label for="inputCustomConfig">Input Custom Config</label>
                                <input type="text" class="form-control" id="inputCustomConfig" placeholder="Enter custom config file" required="">
                            </div>
                        </div>           
                    </form>
                    <br>        
                </div>
            </div> 
        </div>
        <div class="modal-footer d-flex justify-content-between">
            <div id="timestamp"></div> 
            <div>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" id="createScanTask" class="btn btn-primary">Run Scan</button>
            </div>
        </div>
    </div>
</div>
</div> 
{% endblock %}
{% block script %}
<script>
  
    document.addEventListener('DOMContentLoaded', function () {
        var checkTypeDropdown = document.getElementById('checkType');
        var inputFileWrapper = document.getElementById('inputFileWrapper');
        var inputFileWrapper2 = document.getElementById('inputFileWrapper2');
        var checkForm = document.getElementById('checkForm');
        // var spinner = document.getElementById('spinner');
        var addedEntriesGet = document.getElementById('addedEntriesDisplay');
        var removedEntriesGet = document.getElementById('removedEntriesDisplay');
        var changedEntriesGet = document.getElementById('changedEntriesDisplay');
        var taskName = document.getElementById('inputTaskName');

        checkTypeDropdown.addEventListener('change', function () {
            inputFileWrapper.style.display = 'none';
            inputFileWrapper2.style.display = 'none';

            if (this.value === 'specificFile') {
                inputFileWrapper.style.display = 'block';
            } else if (this.value === 'customConfig') {
                inputFileWrapper2.style.display = 'block';
            } else if (this.value === 'customConfigAndFile') {
                inputFileWrapper2.style.display = 'block';
                inputFileWrapper.style.display = 'block';
            }
        });

        //create task
        const createScanTask = document.getElementById('createScanTask');
        
        createScanTask.addEventListener('click', function () { 
            event.preventDefault();
            var formData = new FormData();
            formData.append('checkType', checkTypeDropdown.value);
            formData.append('taskName', taskName.value);
            if (inputFileWrapper.style.display === 'block' && document.getElementById('inputSpecificFile').value) {
                formData.append('specificFile', document.getElementById('inputSpecificFile').value);
            }

            if (inputFileWrapper2.style.display === 'block' && document.getElementById('inputCustomConfig').value) {
                formData.append('customConfig', document.getElementById('inputCustomConfig').value);
            }

            const createAt = new Date().toLocaleString();


            taskForm = `<div class="card mb-3 widget-content">
                    <div class="widget-content-outer">
                        <div class="widget-content-wrapper">
                            <div class="widget-content-left">
                                <div class="widget-heading">${taskName.value}</div>
                                <div class="widget-subheading">${checkTypeDropdown.value}</div>
                            </div>
                            <div class="widget-content-right">       
                                <button class="mb-2 mr-2 btn-transition btn btn-outline-warning">
                                    <i class="fa fa-fw" aria-hidden="true" title="Copy to use pause"></i>
                                </button>
                                <button class="mb-2 mr-2 btn-transition btn btn-outline-danger">
                                    <i class="fa fa-fw" aria-hidden="true" title="Copy to use close"></i>
                                </button>                      
                            </div>
                        </div>
                        <div class="widget-progress-wrapper">
                            <div class="progress-bar-lg progress-bar-animated progress">
                                <div class="progress-bar bg-warning" role="progressbar" aria-valuenow="47" aria-valuemin="0" aria-valuemax="100" style="width: 30%;"></div>
                            </div>
                            <div class="progress-sub-label">
                                <div class="sub-label-left">${createAt}</div>  
                                <div class="sub-label-right" style="margin-right:5%; margin-top: 1%; display: block">
                                    <i class="fa fa-spinner fa-spin" style="font-size: 21px;"></i>                              
                                </div>            
                            </div>   
                        </div>
                    </div>
                </div>`;
                const taskNameForm = document.getElementById('scanTask')
                taskNameForm.innerHTML += taskForm
                checkForm.reset();
                setTimeout(function() {
                    location.reload();
                }, 1000);
                
            fetch('/check', {
                method: 'POST',
                body: formData,
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
       
                    if (data.error) {
                        toastr.error(`Error: ${data.error}`)
                        console.log(data.error)
                    } else {
                        toastr.success('Scan created successfully!')
                    
                }
            })
                .catch((error) => {
                toastr.error(`Error: ${error.message}`);
                    });
            });
        
        //view-result
        const resultButton = document.querySelectorAll(".view-result");
        resultButton.forEach(button => {
            button.addEventListener("click", function() {
                const taskId = this.getAttribute("data-task-id");   
                console.log("task id", taskId)         
                fetch(`/get-result/${taskId}`,{
                    method: 'GET'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Failed to fetch task data");
                        }
                        return response.json();
                    })
                    .then(data => {
                        const taskData = data.data;
                        document.getElementById("totalEntries").innerText = taskData.total_entries;
                        document.getElementById("addedEntries").innerText = taskData.added_entries;
                        document.getElementById("removedEntries").innerText = taskData.removed_entries;
                        document.getElementById("changedEntries").innerText = taskData.changed_entries;
                        document.getElementById("timestamp").innerText = taskData.timestamp;
                        
                        const listAddedEntries = document.getElementById('listAddedEntries');
                        listAddedEntries.innerHTML = "";
                        taskData.added_files.forEach(file => {
                            const li = document.createElement("li");
                            li.textContent = file;
                            li.className = "list-group-item";
                            listAddedEntries.appendChild(li);
                        });
                        const algorithmTableBody = document.getElementById("AlgorithmHash")
                        algorithmTableBody.innerHTML = "";
                        taskData.algorithm.forEach(item => {
                            const row = document.createElement("tr")
                            const algorithmCell = document.createElement("td");
                            algorithmCell.textContent = item.algorithm;
                            row.appendChild(algorithmCell);
                            const valueCell = document.createElement("td");
                            valueCell.textContent = item.value;
                            row.appendChild(valueCell);
                            algorithmTableBody.appendChild(row);
                        });
            })
                    })
                    
        })
        // delete task    
        const deleteButtons = document.querySelectorAll(".delete-task");
        deleteButtons.forEach(button => {
            button.addEventListener("click", function() {
                const taskId = this.getAttribute("data-task-id");
            //  
            // Handle the "Confirm Delete" button
            document.getElementById("confirmDelete").onclick = function () {
                deleteTask(taskId); 
                window.location.reload();     
            };
            
           
            });
        });
        function deleteTask(taskId) {
            fetch(`/delete-task/${taskId}?action=delete`, { // Use GET method with action parameter
                method: "DELETE", // Specify GET instead of DELETE
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success("Task deleted successfully!");
                    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`).closest(".card");
                    taskCard.remove();
                } else {
                    toastr.error("Failed to delete task: " + data.error);
                }
            })
            .catch(error => {
                console.log("Error deleting task:", error);
                toastr.error("An error occurred while deleting the task.");
            });
        }

        document.addEventListener("click", function(event) {
            if (event.target.classList.contains("task-action")) {           
                const taskId = event.target.getAttribute("data-task-id");
                const currentStatus = event.target.getAttribute("data-status");
                const spinnerIcon = document.getElementById('spinner-icon');

                if (currentStatus === "RESUMED" || currentStatus === "PENDING") {
                        if(spinnerIcon) {
                            spinnerIcon.style.display = 'none';
                        }
                    updateTaskStatus(taskId, "pause", event.target);
                }
                if (currentStatus === "PAUSED") {
                        if(spinnerIcon) {
                            spinnerIcon.style.display = 'block';
                        }
                    updateTaskStatus(taskId, "resume", event.target);
                }
            }
            
        });
        function updateTaskStatus(taskId, action, buttonElement) {
            fetch(`/task-${action}/${taskId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastr.success(`Task ${action}d!`);
                        // Update button text and status
                        const newStatus = action === "pause" ? "PAUSED" : "RESUMED";
                        buttonElement.setAttribute("data-status", newStatus);
                        const iconElement = buttonElement.querySelector("i");
                        if (iconElement) {
                            iconElement.className = action === "pause" ? "fa fa-fw" : "fa fa-fw";
                            iconElement.setAttribute("title", action === "pause" ? "Resume Task" : "Pause Task");
                            iconElement.innerHTML = action === "pause" ? "" : ""; // Update icon content
                        }
                        // buttonElement.textContent = action === "pause" ? "Resume" : "Pause";
                    } else {
                        toastr.error(`Failed to ${action} the task.`);
                    }
                })
                .catch(error => {
                    console.error(`Error during task ${action}:`, error);
                });
        }
        function pauseTask(taskId, buttonElement) {
            fetch(`/task-pause/${taskId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastr.success("Task paused!")
                        // Hide the pause button
                        buttonElement.style.display = 'none';
                        // Show the resume button (next sibling)
                        const resumeButton = document.querySelector(`.resume-task[data-task-id="${taskId}"]`);
                        if (resumeButton) {
                            resumeButton.style.display = 'block';
                        }
                    } else {
                        toastr.error('The task cannot stop');
                    }
                })
                .catch(error => {
                    console.log('Error pausing task:', error);
                });
        }

        function resumeTask(taskId, buttonElement) {
            fetch(`/task-resume/${taskId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toastr.success("Task resumed!")
                        // Hide the resume button
                        buttonElement.style.display = 'none';
                        // Show the pause button (previous sibling)
                        const pauseButton = document.querySelector(`.pause-task[data-task-id="${taskId}"]`);
                        console.log(pauseButton)
                        if (pauseButton) {
                            pauseButton.style.display = 'block';
                        }
                    } else {
                        toastr.error('The task cannot resume');
                    }
                })
                .catch(error => {
                    console.log('Error resuming task:', error);
                });
        }
        // compare Aide Database
        const compareButton = document.getElementById('CompareDatabase');
        compareButton.addEventListener("click", function(){
            console.log("Runnning compare command!")
            fetch('/compare-aide-database', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.log("Error running command: ", error);
            });
        })
     

    });  
</script>
{% endblock %}




